# Flat View: Expanded State Resets on Toggle

## Problem
In **flat view**, when toggling filters (especially "Hide Done"), the expanded/collapsed state of type groups resets. All groups collapse, forcing users to re-expand them.

**User Experience:**
```
1. User expands TASKS group to see tasks
2. User toggles "Hide Done" 
3. TASKS group collapses → User loses place
4. User must re-expand TASKS → Frustration
```

**Expected:** Type groups should remember expanded state across filter toggles.

## Root Cause

Current implementation:
```typescript
toggleHideDone(): void {
  this.filterState.hideDone = !this.filterState.hideDone;
  this.refresh(); // ← Fires onDidChangeTreeData event
}

// refresh() causes complete TreeView rebuild
refresh(): void {
  this._onDidChangeTreeData.fire(); // ← Loses all state!
}
```

`onDidChangeTreeData.fire()` triggers complete tree rebuild. VS Code doesn't preserve expanded state automatically when tree data changes.

## Solution: State Preservation

**Option A: Smart Refresh (Recommended)**
Only fire change event for affected nodes, not entire tree:

```typescript
private expandedGroups = new Set<string>(); // Track expanded type groups

toggleHideDone(): void {
  this.filterState.hideDone = !this.filterState.hideDone;
  
  // Smart refresh: preserve expanded state
  this.refreshWithState();
}

private refreshWithState(): void {
  // Option 1: Fire event with specific node
  // Only rebuild affected subtrees
  this._onDidChangeTreeData.fire(undefined); // Still rebuilds all
  
  // Option 2: Manual re-expansion after refresh
  this.refresh();
  // Re-expand groups that were expanded before
  // (requires TreeView access)
}
```

**Option B: TreeView State Management**
Store and restore expanded state:

```typescript
// In extension.ts - pass TreeView to provider
const treeView = vscode.window.createTreeView('devcrumbs.itemsView', {
  treeDataProvider: treeDataProvider,
  showCollapseAll: true // ← Enable collapse all button
});

treeDataProvider.setTreeView(treeView);

// In DevCrumbsTreeDataProvider
private treeView?: vscode.TreeView<TreeNode>;
private expandedNodes = new Map<string, boolean>();

setTreeView(treeView: vscode.TreeView<TreeNode>): void {
  this.treeView = treeView;
  
  // Listen to expand/collapse events
  this.treeView.onDidExpandElement(e => {
    this.expandedNodes.set(this.getNodeId(e.element), true);
  });
  
  this.treeView.onDidCollapseElement(e => {
    this.expandedNodes.set(this.getNodeId(e.element), false);
  });
}

toggleHideDone(): void {
  this.filterState.hideDone = !this.filterState.hideDone;
  this.refresh();
  
  // Restore expanded state after refresh
  setTimeout(() => this.restoreExpandedState(), 50);
}

private async restoreExpandedState(): Promise<void> {
  if (!this.treeView) return;
  
  for (const [nodeId, isExpanded] of this.expandedNodes) {
    if (isExpanded) {
      const node = this.findNodeById(nodeId);
      if (node) {
        await this.treeView.reveal(node, { 
          select: false, 
          focus: false,
          expand: true 
        });
      }
    }
  }
}
```

**Option C: Hierarchical View Approach**
Hierarchical view doesn't have this problem because:
- Items are nodes (not groups)
- Expanded state tied to actual items
- Less frequent expand/collapse

**Recommendation:** Use hierarchical view pattern in flat view too:
- TypeGroupNode stores items
- TypeGroupNode tracks own expanded state
- Refresh updates items, not structure

## Implementation Plan

### Step 1: Add TreeView access
```typescript
// In extension.ts
const treeView = vscode.window.createTreeView('devcrumbs.itemsView', {
  treeDataProvider: treeDataProvider
});
treeDataProvider.setTreeView(treeView);
```

### Step 2: Track expanded state
```typescript
private treeView?: vscode.TreeView<TreeNode>;
private expandedGroups = new Set<string>();

setTreeView(treeView: vscode.TreeView<TreeNode>): void {
  this.treeView = treeView;
  
  this.treeView.onDidExpandElement(e => {
    if (e.element instanceof TypeGroupNode) {
      this.expandedGroups.add(e.element.getType());
    }
  });
  
  this.treeView.onDidCollapseElement(e => {
    if (e.element instanceof TypeGroupNode) {
      this.expandedGroups.delete(e.element.getType());
    }
  });
}
```

### Step 3: Restore state after refresh
```typescript
toggleHideDone(): void {
  this.filterState.hideDone = !this.filterState.hideDone;
  this.refresh();
  this.restoreExpandedGroups();
}

private async restoreExpandedGroups(): Promise<void> {
  if (!this.treeView) return;
  
  // Wait for tree to rebuild
  await new Promise(resolve => setTimeout(resolve, 50));
  
  // Get current root nodes
  const rootNodes = await this.getChildren();
  
  // Re-expand groups that were expanded
  for (const node of rootNodes) {
    if (node instanceof TypeGroupNode && 
        this.expandedGroups.has(node.getType())) {
      await this.treeView.reveal(node, { 
        select: false,
        focus: false,
        expand: 1 // Expand one level
      });
    }
  }
}
```

### Step 4: Add getType() to TypeGroupNode
```typescript
class TypeGroupNode extends TreeNode {
  constructor(
    private type: string,
    private count: number,
    private items: WorkItem[],
  ) {
    super();
  }
  
  getType(): string {
    return this.type;
  }
}
```

## Benefits
- **Consistent UX** - Matches hierarchical view behavior
- **Less frustration** - Users keep their place when filtering
- **Standard pattern** - VS Code Problems view does this
- **Better usability** - Reduces clicks and cognitive load

## Acceptance Criteria
- [ ] Type groups remember expanded state across filter toggles
- [ ] Works for all filter operations (hideDone, status, priority, type, tags)
- [ ] Works for sort operations
- [ ] Expanded state persists during view refresh
- [ ] No flickering or visual glitches during restore
- [ ] Performance: Restore completes in <100ms

## Testing
1. Expand TASKS group in flat view
2. Toggle "Hide Done" → TASKS stays expanded ✅
3. Apply status filter → TASKS stays expanded ✅
4. Sort by priority → TASKS stays expanded ✅
5. Clear filters → TASKS stays expanded ✅
6. Refresh view → TASKS stays expanded ✅

## Edge Cases
- What if filtered items change group membership?
- What if group becomes empty after filter?
- Multiple groups expanded simultaneously?

## Related
- TASK-034 (Description badge - same TreeView access needed)
- BUG-006 (Hierarchical view filter)
- TASK-031 (Hide Done toggle)